{"version":3,"sources":["src/adapter/queries_sparql.ts"],"names":[],"mappings":"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","file":"src/adapter/queries_sparql.js","sourcesContent":["/** @module */\nimport mappings = require(\"./sparql_mappings\");\nimport gpatterns = require(\"./sparql_graphpatterns\");\nimport qsBuilder = require(\"./querystring_builder\");\nimport ODataQueries = require(\"../odata/queries\");\nimport Schema = require(\"../odata/schema\");\n\n/**\n * Used to generate query objects which can be run to modify and/or retrieve data.\n */\nexport class QueryFactory {\n  constructor(private model: ODataQueries.QueryModel, private schema) { }\n  public create(): ODataQueries.Query {\n    return new EntitySetQuery(this.model, this.schema);\n  }\n}\n\n/**\n * Handles read-only OData queries.\n */\nexport class EntitySetQuery implements ODataQueries.Query {\n  private result: { error?: any, result?: any };\n  constructor(private model: ODataQueries.QueryModel, private schema) { }\n\n  public run(sparqlProvider, cb: (result) => void): void {\n    let setSchema = this.schema.getEntitySet(this.model.entitySetName);\n    let entityType = setSchema.getEntityType();\n\n    let vargen = new mappings.SparqlVariableGenerator();\n    let chosenEntityVar = vargen.next();\n\n    let mapping = new mappings.StructuredSparqlVariableMapping(chosenEntityVar, vargen);\n    let queryContext = new SparqlQueryContext(mapping, entityType, this.model.expandTree);\n    let graphPattern = new gpatterns.ExpandTreeGraphPattern(entityType, this.model.expandTree, mapping);\n    let evaluator = new ODataQueries.QueryResultEvaluator();\n\n    let queryStringBuilder = new qsBuilder.QueryStringBuilder();\n    queryStringBuilder.insertPrefix(\"rdf\", \"http://www.w3.org/1999/02/22-rdf-syntax-ns#\");\n    queryStringBuilder.insertPrefix(\"disco\", \"http://disco-network.org/resource/\");\n    let queryString = queryStringBuilder.fromGraphPattern(graphPattern);\n    // console.log(queryString);\n    sparqlProvider.querySelect(queryString, answer => {\n      if (!answer.error) {\n        this.result = { result: evaluator.evaluate(answer.result, queryContext) };\n      }\n      else {\n        this.result = { error: answer.error };\n      }\n      cb(this.result);\n    });\n  }\n}\n\n/** @class\n * This class provides methods to interpret a SPARQL query result as OData.\n */\nexport class SparqlQueryContext implements ODataQueries.QueryContext {\n  private mapping: mappings.StructuredSparqlVariableMapping;\n  private rootTypeSchema: Schema.EntityType;\n  private remainingExpandBranch: Object;\n\n  constructor(mapping: mappings.StructuredSparqlVariableMapping, rootTypeSchema: Schema.EntityType,\n              remainingExpandBranch) {\n    this.mapping = mapping;\n    this.rootTypeSchema = rootTypeSchema;\n    this.remainingExpandBranch = remainingExpandBranch;\n  }\n\n  public getUniqueIdOfResult(result): string {\n    let variableName = this.mapping.getElementaryPropertyVariable(\"Id\");\n    let obj = result[variableName.substr(1)];\n    if (obj) return obj.value;\n  }\n\n  public forEachElementaryPropertyOfResult(result, fn: (property: string, variable: Schema.Property) => void): void {\n    let self = this;\n    this.mapping.forEachElementaryProperty(function(propertyName, variableName) {\n      let obj = result[variableName.substr(1)];\n      if (obj) fn(obj.value, self.rootTypeSchema.getProperty(propertyName));\n    });\n  }\n\n  public forEachComplexPropertyOfResult(result, fn: (subResult, property: Schema.Property,\n          hasValue: boolean) => void): void {\n    for (let propertyName in this.remainingExpandBranch) {\n      let propertyIdVar = this.mapping.getComplexProperty(propertyName).getElementaryPropertyVariable(\"Id\");\n      let hasValue = result[propertyIdVar.substr(1)] !== undefined;\n      fn(result, this.rootTypeSchema.getProperty(propertyName), hasValue);\n    }\n  }\n\n  public forEachElementaryPropertySchema(fn: (property) => void): void {\n    this.mapping.forEachComplexProperty(function(propertyName, variableName) {\n      fn(this.rootTypeSchema.getProperty(propertyName));\n    });\n  }\n\n  public forEachComplexPropertySchema(fn: (property) => void): void {\n    for (let propertyName in this.remainingExpandBranch) {\n      fn(this.rootTypeSchema.getProperty(propertyName));\n    }\n  }\n\n  public getElementaryPropertyOfResult(result, propertyName: string): any {\n    return result[this.mapping.getElementaryPropertyVariable(propertyName).substr(1)].value;\n  }\n\n  /** Return another context associated with a complex property. */\n  public getSubContext(propertyName: string): SparqlQueryContext {\n    /** @todo is it a good idea to create so many instances? */\n    return new SparqlQueryContext(\n      this.mapping.getComplexProperty(propertyName),\n      this.rootTypeSchema.getProperty(propertyName).getEntityType(),\n      this.remainingExpandBranch[propertyName]);\n  }\n}\n"],"sourceRoot":"/source/"}